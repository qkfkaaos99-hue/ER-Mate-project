<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ER Mate - ìŠ¤ë§ˆíŠ¸ ê°„í˜¸ ë„ìš°ë¯¸</title>
<style>
  /* === í…Œë§ˆ ë³€ìˆ˜ === */
  :root {
    --bg: #0a0a0a; --bg2: #111; --bg3: #1a1a1a; --border: #2a2a2a; --border2: #1a1a1a;
    --text: #e0e0e0; --text2: #9a9a9a; --text3: #888; --text-dim: #666;
    --hdr-bg1: #1a2744; --hdr-bg2: #0f1a30; --hdr-border: #2a4a7a;
    --blue: #7eb8f7; --green: #6adb6a; --red: #ff6b6b; --yellow: #f0c040; --orange: #f0a040;
    --input-bg: #0a0a0a; --input-border: #333; --input-text: #e0e0e0;
    --row-hover: #1a1a2a; --row-hl: #1a1010;
    --cb-bg: #0a0a0a; --cb-border: #444; --cb-checked: #2a6a2a; --cb-checked-border: #4a8a4a;
    --section-cond-bg1: #2a1515; --section-cond-bg2: #1a0a0a; --section-cond-border: #4a2020;
    --section-mand-bg1: #152215; --section-mand-bg2: #0a150a; --section-mand-border: #2a3a2a;
    --panel-hdr-bg1: #1e3050; --panel-hdr-bg2: #152238; --panel-hdr-border: #2a4a6a;
    --modal-bg: #111; --modal-hdr-bg1: #3a3000; --modal-hdr-bg2: #2a2000; --modal-border: #4a3a00;
    --modal-text: #ddd;
    --complete-bg: #0a1a0a; --complete-border: #2a4a2a;
    --overlay-bg: rgba(0,0,0,0.8);
    --btn-ex-bg: #151515; --btn-ex-border: #2a2a2a; --btn-ex-text: #8aba8a;
    --tab-bg: #1a1a1a; --tab-border: #333;
    --task-text: #e8e8e8; --task-done: #555; --detail-done: #444;
    --logo-bg: #2a6abf;
    --dispo-bar-bg: #0f1a30;
    --warn-bg: #1a1500; --warn-border: #4a3a00;
    --prog-bg: #222;
    --svg-check: #fff;
  }
  body.light {
    --bg: #f4f5f7; --bg2: #fff; --bg3: #eef0f2; --border: #d0d4da; --border2: #e2e5ea;
    --text: #1a1a2e; --text2: #555; --text3: #777; --text-dim: #999;
    --hdr-bg1: #1e3a5f; --hdr-bg2: #15294a; --hdr-border: #2a5a9a;
    --blue: #2a6abf; --green: #1a8a1a; --red: #d04040; --yellow: #b08000; --orange: #c07020;
    --input-bg: #fff; --input-border: #c0c4ca; --input-text: #1a1a2e;
    --row-hover: #e8eaf0; --row-hl: #fef0f0;
    --cb-bg: #fff; --cb-border: #aaa; --cb-checked: #2a8a2a; --cb-checked-border: #1a6a1a;
    --section-cond-bg1: #fef0f0; --section-cond-bg2: #fff5f5; --section-cond-border: #e0a0a0;
    --section-mand-bg1: #f0faf0; --section-mand-bg2: #f5fff5; --section-mand-border: #a0c0a0;
    --panel-hdr-bg1: #1e3a5f; --panel-hdr-bg2: #15294a; --panel-hdr-border: #2a5a9a;
    --modal-bg: #fff; --modal-hdr-bg1: #fff3d0; --modal-hdr-bg2: #ffedaa; --modal-border: #d0a030;
    --modal-text: #333;
    --complete-bg: #f0faf0; --complete-border: #a0c0a0;
    --overlay-bg: rgba(0,0,0,0.4);
    --btn-ex-bg: #eef0f2; --btn-ex-border: #c0c4ca; --btn-ex-text: #2a7a2a;
    --tab-bg: #eef0f2; --tab-border: #c0c4ca;
    --task-text: #1a1a2e; --task-done: #aaa; --detail-done: #ccc;
    --logo-bg: #2a6abf;
    --dispo-bar-bg: #e8f0fa;
    --warn-bg: #fff8e0; --warn-border: #d0a030;
    --prog-bg: #d0d4da;
    --svg-check: #fff;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { min-height: 100vh; background: var(--bg); font-family: 'Malgun Gothic', -apple-system, sans-serif; color: var(--text); font-size: 13px; transition: background .2s, color .2s; }
  header { background: linear-gradient(180deg, var(--hdr-bg1), var(--hdr-bg2)); border-bottom: 2px solid var(--hdr-border); padding: 6px 12px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 100; }
  .hdr-left { display: flex; align-items: center; gap: 8px; }
  .hdr-logo { background: var(--logo-bg); color: #fff; font-weight: 800; font-size: 11px; padding: 3px 6px; border-radius: 2px; }
  .hdr-title { color: #fff; font-weight: 700; font-size: 13px; }
  .hdr-sub { color: #8aa; font-size: 11px; margin-left: 6px; }
  .hdr-right { display: flex; align-items: center; gap: 6px; }
  .btn-new { background: var(--hdr-bg1); border: 1px solid var(--hdr-border); color: #fff; padding: 6px 14px; font-size: 12px; cursor: pointer; border-radius: 2px; display: none; touch-action: manipulation; }
  .btn-theme { background: none; border: 1px solid rgba(255,255,255,0.3); color: #fff; padding: 6px 10px; font-size: 14px; cursor: pointer; border-radius: 2px; line-height: 1; touch-action: manipulation; }
  .btn-theme:hover { background: rgba(255,255,255,0.1); }
  .toolbar { background: var(--bg2); border-bottom: 1px solid var(--border); padding: 4px 12px; display: flex; gap: 2px; }
  .tab { padding: 4px 14px; font-size: 11px; background: var(--tab-bg); border: 1px solid var(--tab-border); border-bottom: none; color: var(--yellow); border-radius: 3px 3px 0 0; font-weight: 700; }
  main { max-width: 700px; margin: 0 auto; padding: 8px 10px 80px; }
  .input-panel { background: var(--bg2); border: 1px solid var(--border); border-radius: 2px; margin-bottom: 8px; }
  .input-header { background: linear-gradient(180deg, var(--panel-hdr-bg1), var(--panel-hdr-bg2)); padding: 5px 10px; font-size: 11px; font-weight: 700; color: #fff; border-bottom: 1px solid var(--panel-hdr-border); }
  .input-body { padding: 8px; }
  textarea { width: 100%; min-height: 100px; padding: 8px; background: var(--input-bg); border: 1px solid var(--input-border); color: var(--input-text); font-family: 'Malgun Gothic', monospace; font-size: 12px; resize: vertical; outline: none; line-height: 1.7; border-radius: 1px; }
  textarea:focus { border-color: var(--blue); }
  textarea::placeholder { color: var(--text-dim); }
  
  .btn-run { width: 100%; margin-top: 6px; padding: 14px 0; background: var(--hdr-bg1); border: 1px solid var(--hdr-border); color: var(--text-dim); font-size: 14px; font-weight: 700; cursor: pointer; border-radius: 4px; -webkit-tap-highlight-color: rgba(0,0,0,0); touch-action: manipulation; user-select: none; -webkit-user-select: none; }
  .btn-run.active { color: #fff; background: var(--blue); border-color: var(--blue); }
  .btn-run.active:active { opacity: 0.7; }
  
  .examples { padding: 6px 0; display: flex; flex-wrap: wrap; gap: 4px; }
  .ex-label { font-size: 10px; color: var(--text3); margin-bottom: 4px; }
  .btn-ex { padding: 6px 12px; background: var(--btn-ex-bg); border: 1px solid var(--btn-ex-border); color: var(--btn-ex-text); font-size: 12px; cursor: pointer; border-radius: 2px; touch-action: manipulation; -webkit-tap-highlight-color: rgba(0,0,0,0); }
  .result { animation: fi 0.15s ease; }
  @keyframes fi { from{opacity:0} to{opacity:1} }
  .dispo-bar { background: var(--dispo-bar-bg); border: 1px solid var(--hdr-border); border-radius: 2px; padding: 8px 10px; margin-bottom: 6px; display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
  .dispo-emoji { font-size: 16px; }
  .dispo-type { font-size: 14px; font-weight: 800; }
  .dispo-tag { font-size: 10px; font-weight: 700; padding: 1px 6px; border-radius: 2px; border: 1px solid; }
  .dispo-info { font-size: 11px; color: var(--text2); margin-left: auto; }
  .warn-bar { background: var(--warn-bg); border: 1px solid var(--warn-border); border-radius: 2px; padding: 6px 10px; margin-bottom: 6px; color: var(--yellow); font-size: 12px; }
  .progress-row { display: flex; align-items: center; gap: 8px; padding: 5px 10px; background: var(--bg2); border: 1px solid var(--border); border-radius: 2px; margin-bottom: 8px; }
  .prog-label { font-size: 10px; color: var(--text3); white-space: nowrap; }
  .prog-track { flex: 1; height: 4px; background: var(--prog-bg); border-radius: 1px; overflow: hidden; }
  .prog-fill { height: 100%; transition: width 0.3s; border-radius: 1px; }
  .prog-text { font-size: 11px; font-weight: 700; white-space: nowrap; }
  .section-hdr { border: 1px solid; border-radius: 2px; padding: 4px 10px; font-size: 11px; font-weight: 700; margin-bottom: 2px; display: flex; align-items: center; gap: 6px; }
  .section-hdr.cond { color: var(--red); border-color: var(--section-cond-border); background: linear-gradient(180deg, var(--section-cond-bg1), var(--section-cond-bg2)); }
  .section-hdr.mand { color: var(--green); border-color: var(--section-mand-border); background: linear-gradient(180deg, var(--section-mand-bg1), var(--section-mand-bg2)); }
  .section-dot { width: 6px; height: 6px; border-radius: 1px; display: inline-block; }
  .row { display: flex; align-items: flex-start; border-bottom: 1px solid var(--border2); cursor: pointer; transition: background 0.1s; touch-action: manipulation; -webkit-tap-highlight-color: rgba(0,0,0,0); }
  .row:hover { background: var(--row-hover); }
  .row.done-row { opacity: 0.3; }
  .row.hl { background: var(--row-hl); }
  .row-check { width: 32px; min-height: 34px; display: flex; align-items: center; justify-content: center; border-right: 1px solid var(--border2); flex-shrink: 0; }
  .cb { width: 14px; height: 14px; border: 1px solid var(--cb-border); background: var(--cb-bg); display: flex; align-items: center; justify-content: center; border-radius: 1px; }
  .cb.checked { background: var(--cb-checked); border-color: var(--cb-checked-border); }
  .cb svg { display: none; }
  .cb.checked svg { display: block; }
  .row-icon { width: 28px; min-height: 34px; display: flex; align-items: center; justify-content: center; font-size: 12px; flex-shrink: 0; }
  .row-content { flex: 1; padding: 7px 10px; min-width: 0; }
  .row-task { font-size: 13px; font-weight: 600; color: var(--task-text); line-height: 1.4; }
  .row-task.done { color: var(--task-done); text-decoration: line-through; }
  .row-detail { font-size: 12px; color: var(--text2); margin-top: 3px; line-height: 1.5; }
  .row-detail.done { color: var(--detail-done); }
  .complete-bar { background: var(--complete-bg); border: 1px solid var(--complete-border); border-radius: 2px; padding: 14px; text-align: center; margin-top: 8px; }
  .overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: var(--overlay-bg); display: flex; align-items: center; justify-content: center; z-index: 999; padding: 16px; }
  .modal { background: var(--modal-bg); border: 2px solid var(--yellow); border-radius: 3px; max-width: 400px; width: 100%; box-shadow: 0 0 30px rgba(240,192,64,0.15); }
  .modal-hdr { background: linear-gradient(180deg, var(--modal-hdr-bg1), var(--modal-hdr-bg2)); padding: 8px 12px; font-size: 13px; font-weight: 700; color: var(--yellow); border-bottom: 1px solid var(--modal-border); text-align: center; }
  .modal-body { padding: 12px; }
  .modal-item { display: flex; gap: 8px; margin-bottom: 5px; font-size: 12px; color: var(--modal-text); line-height: 1.6; }
  .btn-modal-ok { width: 100%; margin-top: 10px; padding: 12px 0; background: linear-gradient(180deg, var(--modal-hdr-bg1), var(--modal-hdr-bg2)); border: 1px solid var(--modal-border); color: var(--yellow); font-size: 13px; font-weight: 700; cursor: pointer; border-radius: 2px; touch-action: manipulation; }
  details { margin-top: 10px; }
  summary { font-size: 11px; color: var(--text3); cursor: pointer; padding: 4px 0; border-bottom: 1px solid var(--border2); }
  .edit-box { margin-top: 4px; }
  .edit-box textarea { min-height: 80px; }
  .btn-regen { width: 100%; margin-top: 4px; padding: 6px 0; background: var(--hdr-bg1); border: 1px solid var(--hdr-border); color: #fff; font-size: 11px; font-weight: 700; cursor: pointer; border-radius: 2px; }
  .hidden { display: none !important; }
</style>
</head>
<body>
<header>
  <div class="hdr-left">
    <span class="hdr-logo" style="background:var(--blue);">EM</span>
    <span class="hdr-title">ER Mate</span>
    <!-- === ë²„ì „ === -->
    <span class="hdr-sub">v1.0 | 2026.02.19</span> 
  </div>
  <div class="hdr-right">
    <button class="btn-theme" id="btnTheme" onclick="toggleTheme()">â˜€ï¸</button>
    <button class="btn-new" id="btnReset" onclick="resetAll()">ìƒˆë¡œê³ ì¹¨</button>
  </div>
</header>

<div class="toolbar">
  <div class="tab">ì›Œí¬ìŠ¤í…Œì´ì…˜</div>
</div>

<main>
  <div id="inputScreen">
    <div class="input-panel">
      <div class="input-header">â–¶ ìŠ¤ë§ˆíŠ¸ ì˜¤ë” ë¶„ì„ / í”„ë¡œí† ì½œ ê²€ìƒ‰</div>
      <div class="input-body">
        <textarea id="inputText" 
          placeholder="[ì‚¬ìš©ë²•]
1. ì»¨ì„¤íŠ¸ ë³µì‚¬ë¶™ì—¬ë„£ê¸° â†’ í‡´ì‹¤ ì²´í¬ë¦¬ìŠ¤íŠ¸ ìƒì„±
   ğŸ“‹ ë³µì‚¬ë²”ìœ„: [ì…ì›ê²½ê³¼] ~ [í‡´ì›ì¥ì†Œ] ê¹Œì§€
2. ì‹œìˆ ëª…(ERCP, CAG ë“±)ë§Œ ì…ë ¥ â†’ í‘œì¤€ ì§€ì¹¨ì„œ ì¦‰ì‹œ ì¡°íšŒ

Enter = ì‹¤í–‰ / Shift+Enter = ì¤„ë°”ê¿ˆ" 
          oninput="updateBtn()" onpaste="setTimeout(updateBtn,50)" onchange="updateBtn()"
          onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();generate();}"></textarea>
        <button class="btn-run active" id="btnGen">âš¡ ER Mate ë¶„ì„ ì‹¤í–‰</button>
      </div>
    </div>
    
    <div class="ex-label">ë¹ ë¥¸ ì‹¤í–‰ (ì˜ˆì‹œ)</div>
    <div class="examples" id="exCon">
    </div>

    <div style="margin-top:15px; padding:10px; background:var(--bg2); border:1px solid var(--border); border-radius:4px; font-size:11px; color:var(--text3);">
      <strong>ğŸ’¡ Tip:</strong> 'ERCP', 'PTBD' ì²˜ëŸ¼ ë‹¨ì–´ë§Œ ì…ë ¥í•˜ë©´ ì‹œìˆ  ì¤€ë¹„ì‚¬í•­ì„ ë°”ë¡œ ì•Œë ¤ë“œë ¤ìš”!<br>
<strong>ğŸ“‹ ë³µì‚¬ë²”ìœ„:</strong> ì§„ë£Œê¸°ë¡ì¡°íšŒ â†’ <u>ì…ì›ê²½ê³¼</u> ~ <u>í‡´ì›ì¥ì†Œ</u>ê¹Œì§€ ë“œë˜ê·¸ ë³µì‚¬ í›„ ë¶™ì—¬ë„£ê¸°!
    </div>
  </div>

  <div id="resultScreen" class="hidden result"></div>

  <div id="reminderPopup" class="overlay hidden">
    <div class="modal">
      <div class="modal-hdr">âš¡ ë†“ì¹˜ê¸° ì‰¬ìš´ í‡´ì› ì˜¤ë” ì²´í¬!</div>
      <div class="modal-body">
        <div class="modal-item"><span>ğŸ“…</span><span>ì™¸ë˜ ì˜ˆì•½ í™•ì¸í•˜ì…¨ë‚˜ìš”? (ì§ì ‘ ì˜ˆì•½ or ì£¼ì¹˜ì˜ í™•ì¸)</span></div>
        <div class="modal-item"><span>ğŸ’Š</span><span>í‡´ì›ì•½ ì ‘ìˆ˜ í™•ì¸ & ë‚¨ì€ ì•½ ë°˜ë‚©</span></div>
        <div class="modal-item"><span>ğŸ§ </span><span>íŠ¹ìˆ˜ê²€ì‚¬(EEG, Holter) ì˜ˆì•½ í™•ì¸</span></div>
        <button class="btn-modal-ok" onclick="closeReminder()">ë„¤, í™•ì¸í–ˆìŠµë‹ˆë‹¤!</button>
      </div>
    </div>
  </div>
</main>

<script>
const MANDATORY={discharge:[{id:"m_d1",task:"í‡´ì›ì•½ í™•ì¸",detail:"ì •ê·œ:ì‘ê¸‰ì•½êµ­ ë³´í˜¸ìì§ì ‘ìˆ˜ë ¹ / ë¹„ì •ê·œ:ê¸°ì†¡ê´€orë³´ì¡°ì›SMS",icon:"ğŸ’Š"},{id:"m_d2",task:"ë‚¨ì€ì•½ ë°˜ë‚©",detail:"ë°˜ë‚©ìš©ì§€+ì•½â†’ì†Œë…ë¬¼ì‹¤+60ì‚ë¡ / ì ‘ìˆ˜ë§Œëœì•½â†’ì•½êµ­82)2592ì „í™”ì·¨ì†Œ",icon:"â†©ï¸"},{id:"m_d3",task:"Line ì œê±°",detail:"IV line ë“± ì œê±°",icon:"ğŸ’‰"},{id:"m_d4",task:"í‡´ì›ê°„í˜¸ê¸°ë¡ì§€ ì „ë‹¬",detail:"ìˆ˜ë‚© ì „ë‹¬",icon:"ğŸ“„"},{id:"m_d5",task:"ì‘ê¸‰ì‹¤í‡´ì‹¤ê°„í˜¸ê¸°ë¡",detail:"í‡´ì‹¤ì¼ì‹œ=ê°„í˜¸ê¸°ë¡'í‡´ì›í•¨'ì‹œê°„",icon:"âœï¸"},{id:"m_d6",task:"ì¹¨ìƒì •ë¦¬",detail:"#59ì‚ë¡, ì¼€ì´ë¸”Â·ì´ë¦„í‘œÂ·ì“°ë ˆê¸°ì •ë¦¬",icon:"ğŸ§¹"}],admission:[{id:"m_a1",task:"ì…ì›ì§€ì‹œ í™•ì¸",detail:"ë‚´ê³¼â†’EMO / ì™¸ê³¼â†’ì§„ë£Œê³¼ì§ì ‘ë°œí–‰",icon:"ğŸ“‹"},{id:"m_a2",task:"ë³‘ì‹¤ë°°ì •",detail:"ë³‘ë™ì „í™”â†’ìë¦¬+ìˆ˜ì†+ì¸ê³„ì‹œê°„í™•ì¸",icon:"ğŸ›ï¸"},{id:"m_a3",task:"ì…ì›ìˆ˜ì† ì•ˆë‚´",detail:"ë³´í˜¸ìì—ê²Œ ì…ì›ì§€ì‹œë¼ë²¨â†’ì‘ê¸‰ì›ë¬´ìˆ˜ë‚©ì•ˆë‚´",icon:"ğŸ¥"},{id:"m_a4",task:"ì•½ ë°˜ë‚© í™•ì¸",detail:"ë‚¨ì€ì•½ ë°˜ë‚©ì²˜ë¦¬",icon:"â†©ï¸"},{id:"m_a5",task:"ì „ê³¼ì „ë™ê¸°ë¡ì§€",detail:"ì¸ê³„ì „ ì˜¬ë ¤ë†“ê¸°",icon:"ğŸ“„"},{id:"m_a6",task:"ì¸ê³„",detail:"ê²€ì²´Â·pen insulinë“± í•¨ê»˜ì¸ê³„. ìˆ˜í˜ˆë‚¨ìœ¼ë©´ ë³‘ë™ì•Œë¦¬ê¸°",icon:"ğŸ¤"},{id:"m_a7",task:"ì´ì†¡ë“±ë¡",detail:"í‡´ì‹¤ì „ ë¯¸ë¦¬ë“±ë¡!(ì´ë¦„ë¹ ì§€ë©´ ì´ì†¡ëª»í•¨)",icon:"ğŸš¶"},{id:"m_a8",task:"ì‘ê¸‰ì‹¤í‡´ì‹¤ê°„í˜¸ê¸°ë¡",detail:"ì²˜ì¹˜Â·ê²€ì‚¬Â·ì˜¤ë” ì¬í™•ì¸í›„ ì‘ì„±",icon:"âœï¸"},{id:"m_a9",task:"ì¹¨ìƒì •ë¦¬",detail:"#59ì‚ë¡, ì¼€ì´ë¸”Â·ì´ë¦„í‘œì •ë¦¬",icon:"ğŸ§¹"}],transfer:[{id:"m_t1",task:"ì „ì›ë™ì˜ì„œ",detail:"ì£¼ì¹˜ì˜ë°ì˜ë¢°í•œê°ê³¼",icon:"ğŸ“"},{id:"m_t2",task:"ì „ì›ì†Œê²¬ì„œ",detail:"ì´ì†¡ìˆ˜ë‹¨Â·ë³‘ì›ì´ë¦„. ì •ê·œ:ì „ì›ì „ë‹´ê°„í˜¸ì‚¬",icon:"ğŸ“„"},{id:"m_t3",task:"ì˜ë¬´ê¸°ë¡ë³µì‚¬",detail:"ì „ì›ì „ë‹´ê°„í˜¸ì‚¬",icon:"ğŸ“‹"},{id:"m_t4",task:"CD/DVDë³µì‚¬",detail:"ë¹„ì •ê·œ:PACSì‹¤82)3077â†’SMSë³´ì¡°ì›ìˆ˜ë ¹",icon:"ğŸ’¿"},{id:"m_t5",task:"ì „ì›íšŒì‹ í™•ì¸",detail:"ì§„ë£Œí˜‘ë ¥ì„¼í„°ê²½ìœ ì—¬ë¶€í™•ì¸",icon:"ğŸ“"},{id:"m_t6",task:"êµ¬ê¸‰ì°¨ì•ˆë‚´",detail:"ì‚¬ì„¤ê¸°ë³¸8ë§Œì›/ì±„í˜ˆì‹¤#0896",icon:"ğŸš‘"},{id:"m_t7",task:"í‡´ì‹¤30ë¶„ì „V/S",detail:"ë¬¸ì œì‹œì „ì›ì „ë‹´ìŒ¤ì•Œë¦¬ê¸°!",icon:"ğŸ’“"},{id:"m_t8",task:"í‡´ì›ì•½í™•ì¸",detail:"í•„ìš”ì‹œí‡´ì›ì•½ì•ˆë‚´",icon:"ğŸ’Š"},{id:"m_t9",task:"ì™¸ë˜ì˜ˆì•½í™•ì¸",detail:"ë‹¤ìŒì™¸ë˜ê¼­í™•ì¸!",icon:"ğŸ“…"},{id:"m_t10",task:"ì‘ê¸‰ì‹¤í‡´ì‹¤ê°„í˜¸ê¸°ë¡",detail:"ì‘ì„±&ì´ë¦„ë¹¼ê¸°",icon:"âœï¸"},{id:"m_t11",task:"ì¹¨ìƒì •ë¦¬",detail:"#59ì‚ë¡ì •ë¦¬",icon:"ğŸ§¹"}]};

const PROCEDURE_DB = {
  "ERCP": {
    keywords: /ERCP|ì´ì•Œì”¨í”¼|ë‚´ì‹œê²½ì—­í–‰ë‹´ì·Œê´€ì¡°ì˜/i,
    prep: ["ì§„ì • ë‚´ì‹œê²½ì  ì—­í–‰ì„± ë‹´ì·Œê´€ ë°°ì•¡ìˆ  ë™ì˜ì„œ í™•ì¸", "NPO(ê¸ˆì‹) ìœ ì§€", "ë³´í˜¸ì ë™ë°˜ í•„ìˆ˜", "Pre-lab: CBC, PT/aPTT"],
    med: ["ì˜ˆë°©ì  í•­ìƒì œ í™•ì¸", "ì²« ERCP ì‹œ Futhan(Nafamostat) íˆ¬ì•½í• ì§€ í™•ì¸"],
    post: ["4hr Post-lab: Amy/Lip + Abd supine/erect í™•ì¸", "Abd pain ì‚¬ì •"],
    warning: ["âš ï¸ Pancreatitis ë°œìƒ ì£¼ì˜", "âš ï¸ Massive Hydration(Hartmann Sol) í•„ìš” ê°€ëŠ¥ì„±"],
    transfer: ["ì†Œí™”ê¸°ë‚´ì‹œê²½ì„¼í„°"],
    important: true,
  },
  "EGD": {
    keywords: /\bEGD\b|ìœ„ë‚´ì‹œê²½|ìƒë¶€ë‚´ì‹œê²½|ê°€ìŠ¤íŠ¸ë¡œìŠ¤ì½”í”¼/i,
    prep: ["L-tube ìˆìœ¼ë©´ ì œê±°", "ìœ„ë‚´ì‹œê²½ ê²€ì‚¬ ë™ì˜ì„œ í™•ì¸", "ì¶œí˜ˆì‹œ ë‚´ì‹œê²½ì  ì§€í˜ˆìˆ (Hemostasis)/EVL ë™ì˜ì„œ í•„ìš”", "Pre-lab: CBC, PLT, PT/aPTT, ABO/Rh"],
    med: [],
    post: ["V/S ì²´í¬", "ì¶œí˜ˆ ì§•í›„ ê´€ì°°"],
    warning: [],
    transfer: ["ì†Œí™”ê¸°ë‚´ì‹œê²½ì„¼í„°"],
    important: false,
  },
  "CFS": {
    keywords: /\bCFS\b|ëŒ€ì¥ë‚´ì‹œê²½|ì½œë¡œë…¸ìŠ¤ì½”í”¼/i,
    prep: ["ëŒ€ì¥ë‚´ì‹œê²½ê²€ì‚¬ ë™ì˜ì„œ", "Haprep íˆ¬ì—¬ í™•ì¸", "ì¥ì •ê²° í™•ì¸: #1 ì „ë‚ ì €ë… #2 ë‹¹ì¼ì•„ì¹¨"],
    med: [],
    post: ["V/S ì²´í¬", "Abd pain ì‚¬ì •"],
    warning: [],
    transfer: ["ì†Œí™”ê¸°ë‚´ì‹œê²½ì„¼í„°"],
    important: false,
  },
  "SFS": {
    keywords: /\bSFS\b|sigmoidoscopy|ì—ìŠ¤ìê²°ì¥ë‚´ì‹œê²½/i,
    prep: ["ì—ìŠ¤ìê²°ì¥ë‚´ì‹œê²½ê²€ì‚¬ ë™ì˜ì„œ", "Leclean solution 1~2íšŒ ì¥ì •ê²° í™•ì¸"],
    med: [],
    post: ["V/S ì²´í¬", "Abd pain ì‚¬ì •"],
    warning: [],
    transfer: ["ì†Œí™”ê¸°ë‚´ì‹œê²½ì„¼í„°"],
    important: false,
  },
  "CT": {
    keywords: /\bCT\b/i,
    prep: ["20G ì´ìƒ ì†ëª© ìœ„ Pressureline IV","ì¡°ì˜ì œ ì „ì²˜ì¹˜ í•„ìš”ì‹œ: Mucosten + Avil â†’ 30ë¶„ í›„ ì´¬ì˜", "ì „ì²˜ì¹˜ ì „ CTì‹¤ ì „í™”"],
    med: [],
    post: ["15ë¶„ í›„ ì˜ìƒë³‘ë™ë·°ì–´ í™•ì¸"],
    warning: ["CT angio+3D: TNI í™•ì¸ & HR>70 â†’ betaloc í›„ 30ë¶„ f/u"],
    transfer: ["ì‘ê¸‰CT"],
    important: false,
  },
  "MRI": {
    keywords: /\bMRI\b/i,
    prep: ["20G ì´ìƒ ì†ëª© ìœ„ Pressureline IV","Sedation ì‹œ: midazolam #1 ì¶œë°œ ì‹œ IVS", "ì¤€ë¹„ë¬¼: O2, mask/nasal, ambu, O2 line, fitting mask", "ì´ì†¡ëª¨ë‹ˆí„° + ì „ë¬¸/ì¸í„´ ë™ë°˜"],
    med: [],
    post: ["Sedation í›„ ì˜ì‹/í˜¸í¡ í™•ì¸"],
    warning: [],
    transfer: ["ì‘ê¸‰ MRI"],
    important: false,
  },
  "CAG": {
    keywords: /\bCAG\b|ì‹¬ë„ì|ê´€ìƒë™ë§¥ì¡°ì˜/i,
    prep: ["ì‹¬ë„ììˆ  ë™ì˜ì„œ (ë´‰í•©ê¸° í¬í•¨)", "CCU vs ë³‘ë™ í™•ì¸ â€” CCUë©´ ì…ì‹¤ë™ì˜ì„œ ì¶”ê°€", "Skin prep (ì‚¬íƒ€êµ¬ë‹ˆ) â†’ DPP â†’ Sandbag"],
    med: [],
    post: [],
    warning: [],
    transfer: ["ì‹¬í˜ˆê´€ì¡°ì˜ì‹¤","ìœ„ê¸‰ìƒí™©ì•„ë‹ˆë©´ S-CARë¡œ ë°”ê¿”ì„œ ì´ì†¡"],
    important: false,
  },
  "BAE": {
    keywords: /\bBAE\b|ê¸°ê´€ì§€ë™ë§¥ìƒ‰ì „/i,
    prep: ["ë™ì˜ì„œ 2ê±´: ìƒ‰ì „ìˆ  + ë´‰í•©ê¸°", "Skin prep (ì‚¬íƒ€êµ¬ë‹ˆ) â†’ DPP â†’ Sandbag", "Foley ì—¬ë¶€ í™•ì¸"],
    med: [],
    post: ["ê²€ì‚¬ í›„ 4~8hr ABR(ì ˆëŒ€ì•ˆì •)"],
    warning: [],
    transfer: ["ë³¸ê´€ í˜ˆê´€ì¡°ì˜ì‹¤"],
    important: false,
  },
  "PTBD": {
    keywords: /\bPTBD\b|ê²½í”¼ê²½ê°„ë‹´ì¦™ë°°ì•¡/i,
    prep: ["ê²½í”¼ê²½ê°„ë‹´ë„ë°°ì•¡ìˆ (PTBD) ë™ì˜ì„œ"],
    med: [],
    post: ["QOD dressing", "2ì£¼ 1ë²ˆ bile bag change", "ê²€ì²´ â†’ culture ì£¼ì¹˜ì˜ noti","ì–‡ì€ ì½”ë‹ˆì¹¼íŠœë¸Œ"],
    warning: [],
    transfer: ["ë³¸ê´€ í˜ˆê´€ì¡°ì˜ì‹¤"],
    important: false,
  },
  "abdPCD": {
    keywords: /abd\s*PCD|ë³µë¶€\s*PCD|ê²½í”¼ì ë³µë¶€ë°°ì•¡|ê²½í”¼ì ë°°ì•¡/i,
    prep: ["ë³µë¶€ê²½í”¼ë°°ì•¡ìˆ  ë™ì˜ì„œ"],
    med: [],
    post: ["ê²€ì²´ btl â†’ culture ë‚˜ê°€ëŠ”ì§€ ì£¼ì¹˜ì˜ noti","ì–‡ì€ ì½”ë‹ˆì¹¼íŠœë¸Œ"],
    warning: [],
    transfer: ["ë³¸ê´€ í˜ˆê´€ì¡°ì˜ì‹¤"],
    important: false,
  },
  "chestPCD": {
    keywords: /chest\s*PCD|í‰ë¶€\s*PCD|ê²½í”¼ì í‰ë¶€ë°°ì•¡|pigtail/i,
    prep: ["ê²½í”¼í‰ê´€ì‚½ê´€ìˆ  ë™ì˜ì„œ","Chest bottle ê±¸ì´, íˆ¬ì•½ì‹¤ì— ë„¤ì„ë¼ë²¨ ë¶™ì´ê¸°","í˜ˆì¡° ìš”ì²­ì‹œ chest bottle ëœ¯ì§€ë§ê³  ë³´ë‚´ê¸°"],
    med: [],
    post: [],
    warning: [],
    transfer: ["ì•”ë³‘ì› í˜ˆê´€ì¡°ì˜ì‹¤"],
    important: false,
  },
  "PCN": {
    keywords: /\bPCN\b|ê²½í”¼ì ì‹ ë£¨/i,
    prep: ["ê²½í”¼ì ì‹ ë£¨ ì„¤ì¹˜ìˆ  ë™ì˜ì„œ","ì¢Œìš° í™•ì¸ í•„ìˆ˜"],
    med: [],
    post: ["4hr ABR","QOD dressing"],
    warning: [],
    transfer: ["ì•”ë³‘ì› í˜ˆê´€ì¡°ì˜ì‹¤"],
    important: false,
  },
  "í™€í„°": {
    keywords: /í™€í„°|holter|24ì‹œê°„ì‹¬ì „ë„/i,
    prep: ["ê²€ì‚¬ ì „ ì–‡ì€ ëŸ°ë‹"],
    med: [],
    post: [],
    warning: ["ì •ê·œ: 24ì‹œê°„ ì‹¬ì „ë„ë°© ì˜ˆì•½ / ë¹„ì •ê·œ: 1588-5700 ì „í™” ì•ˆë‚´"],
    transfer: [""],
    important: false,
  },
  "EEG": {
    keywords: /\bEEG\b|ë‡ŒíŒŒ/i,
    prep: [],
    med: [],
    post: [],
    warning: ["ì •ê·œ: ìš°ë¦¬ê°€ ì˜ˆì•½ / ë¹„ì •ê·œ: 1588-5700 ì•ˆë‚´"],
    transfer: ["ë‡ŒíŒŒê²€ì‚¬ì‹¤"],
    important: false,
  },
  "Echo": {
    keywords: /\becho\b|ì‹¬ì´ˆìŒíŒŒ|ì‹¬ì—ì½”/i,
    prep: ["TTEë©´ ë™ì˜ì„œ í•„ìš”ì—†ìŒ","TEEë©´ ê²½ì‹ë„ì´ˆìŒíŒŒ ë™ì˜ì„œ"],
    med: [],
    post: [],
    warning: ["ì£¼ì¹˜ì˜ê°€ ì§ì ‘ ì˜ˆì•½","ì¸í„´ë„ê°€ëŠ¥"],
    transfer: ["ì‹¬ì¥ì´ˆìŒíŒŒì‹¤"],
    important: false,
  },
  "OP": {
    keywords: /\bOP\b|ìˆ˜ìˆ |ì‘ê¸‰ìˆ˜ìˆ |emergency op/i,
    prep: [
      "ìˆ˜ìˆ  ì „ Anti íˆ¬ì—¬ í™•ì¸ (Antibiotics)",
      "ì…ì›ìë¦¬ í™•ì¸ í›„ ìˆ˜ì†",
      "ìˆ˜ìˆ  ì „ ê°„í˜¸ê¸°ë¡ ì‘ì„±",
      "ì „ê³¼ì „ë™ê¸°ë¡ì§€ ì‘ì„± (ì…ì›ë³‘ë™ìš©)",
      "Foley ì‚½ì… ì—¬ë¶€ ì£¼ì¹˜ì˜ í™•ì¸",
      "ìˆ˜ìˆ ë™ì˜ì„œ í™•ì¸ â€” ìˆ˜ìˆ /ë§ˆì·¨ë™ì˜ì„œëŠ” í•´ë‹¹ê³¼ì—ì„œ ë°›ìŒ, ERì—ì„œëŠ” ìˆ˜í˜ˆë™ì˜ì„œê¹Œì§€ë§Œ",
    ],
    med: ["ìˆ˜ìˆ  ì „ Antibiotics íˆ¬ì—¬ ì‹œê°„ í™•ì¸"],
    post: [],
    warning: ["âš ï¸ S-carì— ëˆ•í˜€ì„œ ì´ì†¡", "âš ï¸ ë³‘ë™ì¸ê³„ í›„ ì´ì†¡ë³´ë‚¸ ì‹œê°„ì— ì´ë¦„ë¹¼ê¸°"],
    transfer: [""],
    important: false,
  },
};

const DEPT_NOTES={"GS":"ì •ê·œ:ì™¸ê³¼ì‚¬ë¬´ì‹¤/ë¹„ì •ê·œ:ìˆ˜ë‚©ë¼ë²¨â†’ë³‘ë™","NS":"êµìˆ˜ë‹˜ì–´ë ˆì¸ì§€ í™•ì¸í•„ìš”"};
const UNIT_CONSENTS={"ICU":"ì¤‘í™˜ìì‹¤ì…ì‹¤ë™ì˜ì„œ","CCU":"ì…ì‹¤ë™ì˜ì„œ","Stroke":"ë‡Œì¡¸ì¤‘ì§‘ì¤‘ì¹˜ë£Œì‹¤ë™ì˜ì„œ"};
const EXAMPLES=[{label:"ê°„ë‹¨í‡´ì›",text:"routine w/uìƒ íŠ¹ì´ì†Œê²¬ ì—†ì–´ì„œ r/o URI\nD/C, IMHO opd f/u as scheduled"},{label:"êµìœ¡í¬í•¨í‡´ì›",text:"[ì…ì›ê²°ê³¼]\ní‡´ì›\n[í–¥í›„ê³„íš]\ní˜¸í¡ê³¤ë€ ì§„í–‰, ê°í˜ˆ ë“± ìˆìœ¼ë©´ ER ì¬ë‚´ì› êµìœ¡í•¨.\nì‚°ì†Œí¬í™”ë„ ì¸¡ì • ì˜ í•˜ì‹œë„ë¡í•¨."},{label:"ì»¨ì„¤íŠ¸ë‹µë³€",text:"1. ê·€ê³¼ì ìœ¼ë¡œ ì¶œí˜ˆì˜ ìœ„í—˜ì„± ë†’ì§€ ì•Šë‹¤ë©´, LMWH ë‹¨ê¸°ê°„ ìœ ì§€, ì¶”í›„ ê°ëŸ‰, ì¤‘ë‹¨ì„ ì¶”ì²œë“œë¦½ë‹ˆë‹¤. ì´ì— ëŒ€í•´ì„œëŠ” ì¶”í›„ ì‹ ê²½ê³¼ ì™¸ë˜ë¡œ FU í•´ì£¼ì‹­ì‹œì˜¤.\n2. Sacral insufficiency fractureì— ëŒ€í•´ì„œëŠ” ì •í˜•ì™¸ê³¼ í˜‘ì§„ ì¶”ì²œë“œë¦½ë‹ˆë‹¤.\n3. ì‹ ê²½ê³¼ì ìœ¼ë¡œëŠ” LMWH íˆ¬ì•½ ìœ ì§€í•œë‹¤ë©´ aspirin íˆ¬ì•½ì„ ì§€ì†í•  ì´ìœ ëŠ” ì—†ì„ ê²ƒìœ¼ë¡œ íŒë‹¨í•©ë‹ˆë‹¤."},{label:"GSì…ì›+OP",text:"GS adm, NPO\nOP ë‚´ì¼ 1st"},{label:"CCUì…ì›",text:"CARD adm to CCU, CAG ì˜ˆì •\nlab/EKG í™•ì¸"},{label:"ì „ì›",text:"ì „ì›, 00ë³‘ì› NSë¡œ\nCT/MRI CD ë³µì‚¬ í•„ìš”"},{label:"ERCPì…ì›",text:"GI adm, ERCP ì‹œí–‰ ì˜ˆì •, NPO ìœ ì§€\nENDO OPD f/u 1ê°œì›”"},{label:"í˜ˆì¢…í‡´ì›+ìˆ˜í˜ˆ",text:"[ì…ì›ê²°ê³¼]\ní‡´ì›\n[í–¥í›„ê³„íš]\n* plt Tf í›„ ê·€ê°€\n* ë°œì—´ ë“± ë¬¸ì œ ìˆìœ¼ë©´ ì¬ë‚´ì›\n* ëª©ìš”ì¼ ì˜¤ì „ ì™¸ë˜ f/u"}];

let activeTitle = null; // ê²€ìƒ‰ ëª¨ë“œìš© íƒ€ì´í‹€ ë³€ìˆ˜

function smartParse(text){
const t=text;
const r={disposition:null,departments:[],unit:null,procedures:[],opdItems:[],educationItems:[],npo:false,op:false,conditionalTasks:[],instructions:[],hasTransfusion:false};

// --- Disposition ---
const rsm=t.match(/ì…ì›ê²°ê³¼[^\n]*\n([^\n]*)/);
if(rsm){const rl=rsm[1];if(/ì „ì›|transfer/.test(rl))r.disposition="transfer";else if(/í‡´ì›|D\/C|d\/c|discharge|ê·€ê°€/.test(rl))r.disposition="discharge";else if(/ì…ì›|adm/i.test(rl))r.disposition="admission";}
if(!r.disposition){if(["ì „ì›","transfer","ì´ì†¡"].some(k=>t.includes(k)))r.disposition="transfer";else if(/í‡´ì›|D\/C|d\/c|discharge|ê·€ê°€/.test(t))r.disposition="discharge";else if(/\badm\b/i.test(t))r.disposition="admission";}

// --- ì§„ë£Œê³¼ ---
const dm={"IMR":["IMR","RESP","PULM","í˜¸í¡ê¸°","í˜¸í¡ê¸°ë‚´ê³¼","í„ëª¨","í’€ëª¨"],"IMJ":["IMJ","RHEU","RH","ë¥˜ë§ˆ","ë¥˜ë§ˆí‹°ìŠ¤","ë¥˜ë§ˆí‹°ìŠ¤ë‚´ê³¼","ì¡°ì¸íŠ¸"],"IMN":["IMN","NEPH","ì‹ ì¥","ì‹ ì¥ë‚´ê³¼","ë„¤í”„ë¡œ","RENAL"],"IMHO":["IMHO","HEM","ONCO","HO","í˜ˆì¢…","í˜ˆì•¡ì¢…ì–‘","í˜ˆì•¡ì¢…ì–‘ë‚´ê³¼","í—´","ì˜¹ì½”"],"IMI":["IMI","INFEC","IF","ê°ë‚´","ê°ì—¼","ê°ì—¼ë‚´ê³¼","ì¸í™"],"IMG":["IMG","GI","GASTRO","ì†Œí™”ê¸°","ì†Œí™”ê¸°ë‚´ê³¼","ìœ„ì¥ê´€"],"IMC":["IMC","CV","CARD","CIRC","ìˆœí™˜ê¸°","ì‹¬ì¥","ì‹¬ì¥ë‚´ê³¼","ì¹´ë””ì˜¤"],"IME":["IME","ENDO","META","ë‚´ë¶„ë¹„","ë‚´ë¶„ë¹„ë‚´ê³¼","ë‚´ë¶„ë¹„ëŒ€ì‚¬","ì—”ë„"],"IMA":["IMA","ALLERGY","ALL","ì•Œë ˆë¥´ê¸°","ì•ŒëŸ¬ì§€"],"IMHM":["IMHM","ì…ì „","ì…ì „ì˜","ì…ì›ì „ë‹´","ì…ì›ì „ë‹´ì „ë¬¸ì˜"],"NP":["NP","PSY","ì •ì‹ ","ì •ì‹ ê³¼","ì •ì‹ ê±´ê°•ì˜í•™ê³¼","ì—”í”¼"],"NR":["NR","NU","NEURO","ì‹ ê²½ê³¼","ë‰´ë¡œ","ì—”ì•Œ"],"NS":["NS","N/S","NEUROSURG","ì‹ ê²½ì™¸ê³¼","ì—”ì—ìŠ¤","SPINE","BRAIN"],"GS":["GS","SURG","ì™¸ê³¼","ì¼ë°˜ì™¸ê³¼","ì¥ì—ìŠ¤","HBP","UGI","LGI"],"CS":["CS","TS","THORACIC","í‰ë¶€","í‰ë¶€ì™¸ê³¼","í‰ì™¸"],"OS":["OS","ORTHO","ì •í˜•","ì •í˜•ì™¸ê³¼","ì˜¤ì—ìŠ¤","BONE"],"EM":["EM","ER","ì‘ê¸‰","ì‘ê¸‰ì˜í•™ê³¼"],"PED":["PED","ì†Œì•„","ì†Œì²­ê³¼","í˜ë“œ"],"OBGY":["OBGY","ì‚°ë¶€ì¸ê³¼","ì‚°ê³¼","ë¶€ì¸ê³¼"],"URO":["URO","ë¹„ë‡¨","ë¹„ë‡¨ì˜í•™ê³¼","ìœ ë¡œ"],"ENT":["ENT","OTO","ì´ë¹„ì¸í›„ê³¼","ì´ì—”í‹°"],"RM":["RM","REHAB","ì¬í™œ","ì¬í™œì˜í•™ê³¼","ì•Œì— "]};
for(const[d,ks]of Object.entries(dm))for(const k of ks)if(t.includes(k)&&!r.departments.includes(d))r.departments.push(d);

// --- íŠ¹ìˆ˜ ìœ ë‹› ---
for(const u of Object.keys(UNIT_CONSENTS))if(t.toUpperCase().includes(u.toUpperCase()))r.unit=u;

// --- ê²€ì‚¬/ì‹œìˆ : PROCEDURE_DB í‚¤ì›Œë“œ ë§¤ì¹­ ---
const actionKw=/ì‹œí–‰|ì˜ˆì •|check|ì°|ë³´ë‚´|ì´¬ì˜|ì˜ˆì•½|ì˜ë¢°|ì½œ|call|ì¤€ë¹„|go|schedule|ë‚´ì¼|ëª¨ë ˆ|1st|2nd/i;
const imagingActionKw=/ì‹œí–‰|ì˜ˆì •|ì°|ë³´ë‚´|ì´¬ì˜|ì˜ˆì•½|ì½œ|call|ì¤€ë¹„|go|schedule/i;
const imagingExclude=/ê²°ê³¼|ì†Œê²¬|ìƒ|íŒë…|reading|ë³´ë©´|ì—ì„œ|finding|review/i;
for(const[name,proc]of Object.entries(PROCEDURE_DB)){
  const m=t.match(proc.keywords);
  if(m){
    const idx=t.indexOf(m[0]);
    const nearby=t.substring(Math.max(0,idx-30),Math.min(t.length,idx+m[0].length+30));
    if(name==="CT"||name==="MRI"){
      if(imagingActionKw.test(nearby)&&!imagingExclude.test(nearby))r.procedures.push(name);
    } else {
      if(name!=="OP"&&actionKw.test(nearby))r.procedures.push(name);
    }
  }
}

// --- OPD ---
const opdSet=new Set();
const opdKw=/ì™¸ë˜|OPD|opd|f\/u|F\/U|follow[- ]?up/i;
t.split(/\n/).forEach(line=>{
  const l=line.trim();
  if(!opdKw.test(l))return;
  let extracted=l.replace(/^[\*\-\d\.\)\s]+/,'').trim();
  if(extracted.length>60){
    const match=extracted.match(/.{0,25}(ì™¸ë˜|OPD|f\/u|F\/U|follow[- ]?up).{0,25}/i);
    if(match)extracted=match[0].trim();
  }
  if(extracted.length>3)opdSet.add(extracted);
});
const opdArr=[...opdSet];
const opdFiltered=[];
for(let i=0;i<opdArr.length;i++){
  let skip=false;
  for(let j=0;j<opdArr.length;j++){
    if(i===j)continue;
    const wi=opdArr[i].split(/\s+/),wj=opdArr[j].split(/\s+/);
    const common=wi.filter(w=>w.length>1&&wj.includes(w));
    if(common.length>=2&&opdArr[i].length>opdArr[j].length){skip=true;break;}
  }
  if(!skip)opdFiltered.push(opdArr[i]);
}
r.opdItems=opdFiltered;

// --- êµìœ¡ ---
const es=new Set();
t.split(/[.\n]/).filter(l=>/êµìœ¡í•¨|êµìœ¡í•˜ì˜€|ì„¤ëª…í•¨|í•˜ì‹œë„ë¡|ì¬ë‚´ì›|ì¬ë°©ë¬¸/.test(l)).forEach(l=>{const c=l.trim();if(c.length>3)es.add(c);});
r.educationItems=[...es];

// --- NPO ---
if(/NPO|npo|ê¸ˆì‹/.test(t))r.npo=true;

// --- OP ---
const om=t.match(/(\bOP\b|ìˆ˜ìˆ )/gi);
if(om)for(const m of om){const i=t.indexOf(m),nb=t.substring(Math.max(0,i-30),Math.min(t.length,i+m.length+30));if(/ì˜ˆì •|ë‚´ì¼|ëª¨ë ˆ|1st|2nd|ì‹œí–‰|ì§„í–‰|ì˜¬ë¼ê°€/i.test(nb)&&!/ì•„ë‹˜|ì—†|ì•ˆ |ë¶ˆí•„ìš”|ë¶ˆê°€|ì•ˆí•¨|ì·¨ì†Œ|ë³´ë¥˜/i.test(nb)){r.op=true;break;}}

// --- ì§„ë‹¨ì„œ ---
if(/ì§„ë‹¨ì„œ|ì†Œê²¬ì„œ/.test(t))r.conditionalTasks.push({id:"c_doc",task:"ì§„ë‹¨ì„œ/ì„œë¥˜ë°œê¸‰",detail:"ì£¼ì¹˜ì˜ìš”ì²­(2ë§Œì›,ë¶€ë³¸1ì²œì›)",icon:"ğŸ“‘"});

// --- ìˆ˜í˜ˆ ---
r.hasTransfusion=(/ìˆ˜í˜ˆ|transfusion|RBC|FFP|pheresis|PLT Tf|plt tf/i.test(t));

// --- ì»¨ì„¤íŠ¸ ì§€ì‹œì‚¬í•­ ì¶”ì¶œ ---
const lines=t.split(/\n/);
const instrKw=/ìœ ì§€|ì¶”ì²œ|ê¶Œê³ |ì‹œí–‰|ì¤‘ë‹¨|ë³€ê²½|ê°ëŸ‰|ì¦ëŸ‰|ì¶”ê°€|ì œê±°|ì‹œì‘|ì§€ì†|íˆ¬ì•½|íˆ¬ì—¬|ì²˜ë°©|í˜‘ì§„|consult|ì˜ë¢°|í•´ì£¼|ë°”ëë‹ˆë‹¤|ë¶€íƒ|ë“œë¦½ë‹ˆë‹¤|í•˜ì‹­ì‹œì˜¤|ê³ ë ¤/i;
const skipKw=/^ì…ì›ê²½ê³¼|^ì…ì›ê²°ê³¼|^í–¥í›„ê³„íš|^í‡´ì›ì¥ì†Œ|^ì§„ë£Œê¸°ë¡|^\s*$|adm|ì…ì›/i;
  
for(let i=0;i<lines.length;i++){
  const line=lines[i].trim();
  if(!line||skipKw.test(line)||line.length<5)continue;
  const isNumbered=/^\d+[\.\)]\s*/.test(line)||/^[\*\-]\s+/.test(line);
  if(isNumbered||instrKw.test(line)){
    const cleaned=line.replace(/^\d+[\.\)]\s*/,'').replace(/^[\*\-]\s+/,'').trim();
    if(cleaned.length>5){
      let cat="ì§€ì‹œ";
      if(/ìœ ì§€|ì§€ì†|íˆ¬ì•½|íˆ¬ì—¬|ì²˜ë°©|ì‹œì‘|ì¦ëŸ‰/i.test(cleaned))cat="íˆ¬ì•½";
      if(/ì¤‘ë‹¨|ê°ëŸ‰|ì œê±°|ì—†ì„|ë¶ˆí•„ìš”|ì´ìœ ëŠ” ì—†/i.test(cleaned))cat="íˆ¬ì•½ë³€ê²½";
      if(/í˜‘ì§„|consult|ì˜ë¢°/i.test(cleaned))cat="í˜‘ì§„";
      if(/ì™¸ë˜|OPD|opd|f\/u|FU|follow/i.test(cleaned))cat="ì™¸ë˜";
      if(/ê²€ì‚¬|ì´¬ì˜|imaging|MRI|CT|X-ray|lab|ì‹œí–‰/i.test(cleaned))cat="ê²€ì‚¬";
      if(cat==="ì™¸ë˜"||cat==="êµìœ¡")continue;
      const icons={"íˆ¬ì•½":"ğŸ’Š","íˆ¬ì•½ë³€ê²½":"âš ï¸","í˜‘ì§„":"ğŸ¥","ê²€ì‚¬":"ğŸ”¬","ì§€ì‹œ":"ğŸ“‹"};
      r.instructions.push({id:"instr_"+i,task:cat,detail:cleaned,icon:icons[cat]||"ğŸ“‹",category:cat});
    }
  }
}
return r;
}

function buildChecklist(p){
  const items=[];
  // ì…ì› ì‹œ ê³¼ë³„/ìœ ë‹›ë³„ ì°¸ê³ 
  if(p.disposition==="admission"){
    for(const d of p.departments)if(DEPT_NOTES[d])items.push({id:"dept_"+d,task:d+" ì…ì›ì°¸ê³ ",detail:DEPT_NOTES[d],icon:"ğŸ“Œ",type:"context",highlight:false});
    if(p.unit&&UNIT_CONSENTS[p.unit])items.push({id:"unit_"+p.unit,task:p.unit+" ë™ì˜ì„œ",detail:UNIT_CONSENTS[p.unit],icon:"ğŸ“",type:"conditional",highlight:true});
    if(p.npo)items.push({id:"c_npo",task:"NPOìœ ì§€í™•ì¸",detail:"ê¸ˆì‹ìƒíƒœìœ ì§€",icon:"ğŸš«",type:"conditional"});
    if(p.op){
      const opProc=PROCEDURE_DB["OP"];
      if(opProc){
        opProc.prep.forEach((txt,i)=>items.push({id:"op_prep_"+i,task:txt,detail:"[OP ì¤€ë¹„]",icon:"ğŸ“‹",type:"conditional",highlight:false}));
        opProc.med.forEach((txt,i)=>items.push({id:"op_med_"+i,task:txt,detail:"[OP íˆ¬ì•½]",icon:"ğŸ’Š",type:"conditional"}));
        opProc.warning.forEach((txt,i)=>items.push({id:"op_warn_"+i,task:txt,detail:"[OP ì£¼ì˜]",icon:"âš ï¸",type:"conditional",highlight:true}));
      }
    }
  }
  // ì»¨ì„¤íŠ¸ ì§€ì‹œì‚¬í•­
  for(const instr of p.instructions)items.push({id:instr.id,task:instr.task,detail:instr.detail,icon:instr.icon,type:"conditional",highlight:instr.category==="íˆ¬ì•½ë³€ê²½"||instr.category==="í˜‘ì§„"});
  // ê²€ì‚¬/ì‹œìˆ 
  for(const procName of p.procedures){
    const proc=PROCEDURE_DB[procName];
    if(!proc)continue;
    const pid="proc_"+procName;
    if(proc.prep.length>0)items.push({id:pid+"_prep",task:procName+" ì¤€ë¹„",detail:proc.prep.join(" / "),icon:"ğŸ“‹",type:"conditional"});
    if(proc.med&&proc.med.length>0)items.push({id:pid+"_med",task:procName+" íˆ¬ì•½",detail:proc.med.join(" / "),icon:"ğŸ’Š",type:"conditional"});
    if(proc.post.length>0)items.push({id:pid+"_post",task:procName+" ì‚¬í›„ê´€ë¦¬",detail:proc.post.join(" / "),icon:"ğŸ”",type:"conditional"});
    if(proc.warning.length>0)items.push({id:pid+"_warn",task:procName+" ì£¼ì˜ì‚¬í•­",detail:proc.warning.join(" / "),icon:"âš ï¸",type:"conditional",highlight:proc.important||false});
    if(proc.transfer&&proc.transfer.filter(x=>x).length>0)items.push({id:pid+"_trans",task:procName+" ì´ì†¡",detail:proc.transfer.join(" / "),icon:"ğŸš‘",type:"conditional"});
  }
  // OPD
  for(const o of p.opdItems)items.push({id:"opd_"+o,task:"ì™¸ë˜ì˜ˆì•½í™•ì¸",detail:o,icon:"ğŸ“…",type:"conditional",highlight:true});
  // êµìœ¡
  for(let i=0;i<p.educationItems.length;i++)items.push({id:"edu_"+i,task:"í‡´ì›êµìœ¡",detail:p.educationItems[i],icon:"ğŸ“š",type:"conditional"});
  // ê¸°íƒ€ ì¡°ê±´ë¶€
  for(const c of p.conditionalTasks)items.push({...c,type:"conditional"});
  // ìˆ˜í˜ˆ - dispositionë³„
  if(p.hasTransfusion){
    if(p.disposition==="admission")items.push({id:"c_bf",task:"ìˆ˜í˜ˆ ë³‘ë™ì¸ê³„",detail:"ë‚¨ì€í˜ˆì•¡ ë³‘ë™ì¸ê³„. MF hold ì£¼ì¹˜ì˜í™•ì¸",icon:"ğŸ©¸",type:"conditional"});
    else items.push({id:"c_bf",task:"ìˆ˜í˜ˆ ì™„ë£Œí™•ì¸",detail:"ìˆ˜í˜ˆì™„ë£Œ ì—¬ë¶€ í™•ì¸",icon:"ğŸ©¸",type:"conditional"});
  }
  // í•„ìˆ˜
  (MANDATORY[p.disposition]||[]).forEach(m=>items.push({...m,type:"mandatory"}));
  return items;
}

let cl=[],cs={},cp=null,ci="";

function updateBtn(){
  const btn = document.getElementById("btnGen");
  if(btn) btn.classList.add("active");
}

function generate(text) {
  try {
    const t = (text || document.getElementById("inputText").value).trim();
    if (!t) {
      alert("âš ï¸ ë‚´ìš©ì„ ì…ë ¥í•˜ê±°ë‚˜ ì˜ˆì‹œ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”!");
      return;
    }
    
    // ëª¨ë“œ ì´ˆê¸°í™”
    activeTitle = null;

    // 1ë‹¨ê³„: ê²€ìƒ‰ ëª¨ë“œ (í‚¤ì›Œë“œ ì…ë ¥ ì‹œ ì²´í¬ë¦¬ìŠ¤íŠ¸ë¡œ ë³€í™˜)
    if (t.length < 20) {
      for (const [name, proc] of Object.entries(PROCEDURE_DB)) {
        if (proc.keywords.test(t)) {
          showProtocol(name);
          return; 
        }
      }
    }
    // 2ë‹¨ê³„: ë¶„ì„ ëª¨ë“œ
    ci = t;
    cp = smartParse(t);
    cl = buildChecklist(cp);
    cs = {};
    document.getElementById("inputScreen").classList.add("hidden");
    document.getElementById("resultScreen").classList.add("hidden");
    document.getElementById("btnReset").style.display = "block";
    if (cp.disposition === "discharge" || cp.disposition === "transfer") {
      document.getElementById("reminderPopup").classList.remove("hidden");
    }
    render();
  } catch (err) {
    alert("ì˜¤ë¥˜ ë°œìƒ: " + err.message);
  }
}

// íƒ€ì´í‹€ì„ ë¦¬ìŠ¤íŠ¸ì—ì„œ ë¹¼ê³  ë³„ë„ ë³€ìˆ˜(activeTitle)ë¡œ ê´€ë¦¬
function showProtocol(procName) {
  const proc = PROCEDURE_DB[procName];
  cl = []; // ë¦¬ìŠ¤íŠ¸ ì´ˆê¸°í™”
  
  // í—¤ë” ì„¤ì • (ë¦¬ìŠ¤íŠ¸ì— ë„£ì§€ ì•ŠìŒ)
  activeTitle = { name: procName, icon: "ğŸ“˜" };

  const addItems = (list, prefix, tag, icon, isWarn) => {
    list.forEach((txt, idx) => {
      cl.push({
        id: `${procName}_${prefix}_${idx}`,
        task: txt,
        detail: tag,
        icon: icon,
        type: "manual",
        highlight: isWarn
      });
    });
  };

  if(proc.prep) addItems(proc.prep, "prep", "[ì¤€ë¹„]", "ğŸ“‹", false);
  if(proc.med) addItems(proc.med, "med", "[íˆ¬ì•½]", "ğŸ’Š", false);
  if(proc.post) addItems(proc.post, "post", "[ì‚¬í›„]", "ğŸ”", false);
  if(proc.warning) addItems(proc.warning, "warn", "[ì£¼ì˜]", "âš ï¸", true);
  if(proc.transfer) addItems(proc.transfer.filter(x=>x), "transfer", "[ì´ì†¡]", "ğŸš‘", false);

  cs = {};
  document.getElementById("inputScreen").classList.add("hidden");
  document.getElementById("resultScreen").classList.remove("hidden");
  document.getElementById("btnReset").style.display = "block";
  render();
}

function render(){
  const c=document.getElementById("resultScreen");
  const done=Object.values(cs).filter(Boolean).length;
  const total=cl.length;
  const pct=total?Math.round(done/total*100):0;
  
  let h = "";
  
  // ê²€ìƒ‰ ëª¨ë“œì¼ ë•Œ íƒ€ì´í‹€ í—¤ë”
  if(activeTitle) {
      h += `<div class="complete-bar" style="background:var(--bg2); border:1px solid var(--blue); text-align:left; padding:12px; margin-bottom:10px; display:flex; align-items:center; gap:10px;">
        <span style="font-size:20px;">${activeTitle.icon}</span>
        <div>
            <div style="font-size:15px; font-weight:700; color:var(--blue);">${activeTitle.name} í‘œì¤€ ì§€ì¹¨</div>
            <div style="font-size:11px; color:var(--text2);">ì‹œìˆ  ì „í›„ ê°„í˜¸ í™•ì¸</div>
        </div>
      </div>`;
  } else if (cp && cp.disposition) {
      // ë¶„ì„ ëª¨ë“œ: disposition bar + summary
      const di={admission:{l:"ì…ì›",c:"var(--blue)",bc:"var(--hdr-border)",e:"ğŸ¥"},discharge:{l:"í‡´ì›",c:"var(--green)",bc:"var(--section-mand-border)",e:"ğŸ "},transfer:{l:"ì „ì›",c:"var(--orange)",bc:"var(--warn-border)",e:"ğŸš‘"}};
      const d=di[cp.disposition];
      if(d){
         const tags=cp.departments.map(dp=>`<span class="dispo-tag" style="color:${d.c};border-color:${d.c}">${dp}</span>`).join(' ');
         const utag=cp.unit?`<span class="dispo-tag" style="color:var(--yellow);border-color:var(--yellow)">${cp.unit}</span>`:'';
         const sum=[cp.instructions.length>0&&"ì§€ì‹œ"+cp.instructions.length+"ê±´",cp.procedures.length>0&&"ì‹œìˆ "+cp.procedures.length+"ê±´",cp.opdItems.length>0&&"ì™¸ë˜"+cp.opdItems.length+"ê±´",cp.educationItems.length>0&&"êµìœ¡"+cp.educationItems.length+"ê±´",cp.npo&&"NPO",cp.op&&cp.disposition==="admission"&&"OPì˜ˆì •"].filter(Boolean).join(" Â· ")||"ì¶”ê°€í•­ëª©ì—†ìŒ";
         h+=`<div class="dispo-bar" style="border-color:${d.bc}"><span class="dispo-emoji">${d.e}</span><span class="dispo-type" style="color:${d.c}">${d.l}</span>${tags}${utag}<span class="dispo-info">${sum}</span></div>`;
      }
  } else if(cp && !cp.disposition) {
      h+='<div class="warn-bar">âš ï¸ Disposition íŒë³„ ë¶ˆê°€ â€” ì…ì›/í‡´ì›/ì „ì› í‚¤ì›Œë“œë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤</div>';
  }

  h += `<div class="progress-row"><span class="prog-label">ì§„í–‰</span><div class="prog-track"><div class="prog-fill" style="width:${pct}%;background:${pct===100?'var(--green)':'var(--red)'}"></div></div><span class="prog-text" style="color:${pct===100?'var(--green)':'var(--red)'};">${done}/${total}</span></div>`;
  
  // ê²€ìƒ‰ ëª¨ë“œ: ì„¹ì…˜ êµ¬ë¶„ ì—†ì´ ë°”ë¡œ í‘œì‹œ
  if(activeTitle){
    cl.forEach(i=>{h+=rItem(i);});
  } else {
    // ë¶„ì„ ëª¨ë“œ: ì§€ì‹œì—ì„œ ì¶”ì¶œ / í•„ìˆ˜ í•­ëª© êµ¬ë¶„
    const cond=cl.filter(x=>x.type==="conditional"||x.type==="context");
    const mand=cl.filter(x=>x.type==="mandatory");
    if(cond.length>0){
      h+=`<div class="section-hdr cond"><span class="section-dot" style="background:var(--red)"></span>ì§€ì‹œì—ì„œ ì¶”ì¶œ</div>`;
      cond.forEach(i=>{h+=rItem(i);});
    }
    if(mand.length>0){
      h+=`<div class="section-hdr mand" style="margin-top:6px"><span class="section-dot" style="background:var(--green)"></span>í•„ìˆ˜ í•­ëª©</div>`;
      mand.forEach(i=>{h+=rItem(i);});
    }
  }
  
  if(pct===100)h+=`<div class="complete-bar"><div style="font-size:24px;margin-bottom:4px">âœ…</div><div style="font-size:13px;font-weight:700;color:var(--green)">ì „ì²´ ì™„ë£Œ</div></div>`;
  
  // ë¶„ì„ ëª¨ë“œì¼ ë•Œë§Œ ì›ë¬¸ ë³´ê¸°
  if(!activeTitle && ci) {
      h+=`<details><summary>â–¶ ì›ë¬¸ë³´ê¸°/ìˆ˜ì •</summary><div class="edit-box"><textarea oninput="ci=this.value">${esc(ci)}</textarea><button class="btn-regen" onclick="regen()">â–¶ ë‹¤ì‹œìƒì„±</button></div></details>`;
  }
  
  c.innerHTML=h;
  c.classList.remove("hidden");
}

function rItem(item){
  const d=cs[item.id],hl=item.highlight&&!d;
  const rc=d?"row done-row":(hl?"row hl":"row");
  const ck=d?'<div class="cb checked"><svg width="10" height="10" viewBox="0 0 12 12" fill="none"><path d="M2.5 6L5 8.5L9.5 3.5" stroke="var(--svg-check)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></div>':'<div class="cb"></div>';
  const tc=d?"row-task done":"row-task";
  const dc=d?"row-detail done":"row-detail";
  return `<div class="${rc}" onclick="tog('${item.id}')"><div class="row-check">${ck}</div><div class="row-icon">${item.icon}</div><div class="row-content"><div class="${tc}">${esc(item.task)}</div>${item.detail?`<div class="${dc}">${esc(item.detail)}</div>`:''}</div></div>`;
}

function tog(id){cs[id]=!cs[id];render();}
function esc(s){return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
function closeReminder(){document.getElementById("reminderPopup").classList.add("hidden");}
function resetAll(){location.reload();}
function toggleTheme(){
   document.body.classList.toggle('light');
   localStorage.setItem('theme', document.body.classList.contains('light') ? 'light' : 'dark');}
function regen(){ const ta=document.querySelector("#resultScreen textarea"); if(ta){ci=ta.value; generate(ci);} }

window.onload = function() {
    if(localStorage.getItem('theme')==='light') document.body.classList.add('light');
    updateBtn();

    // ë¶„ì„ ì‹¤í–‰ ë²„íŠ¼
    const btnGen = document.getElementById("btnGen");
    if(btnGen){
      btnGen.addEventListener('touchend', function(e){
        e.preventDefault();
        document.getElementById('inputText').blur();
        generate();
      });
      btnGen.addEventListener('click', function(e){
        generate();
      });
    }

    // ì˜ˆì‹œ ë²„íŠ¼
    const ec=document.getElementById("exCon");
    if(ec) {
        EXAMPLES.forEach(ex=>{
          const b=document.createElement("button");
          b.className="btn-ex";
          b.textContent=ex.label;
          b.addEventListener('touchend', function(e){ e.preventDefault(); document.getElementById("inputText").value=ex.text; generate(ex.text); });
          b.addEventListener('click', function(){ document.getElementById("inputText").value=ex.text; generate(ex.text); });
          ec.appendChild(b);
        });
    }
};
</script>
</body>
</html>
